<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              blu: "#1a73e8",
            },
            fontFamily: {
              times: ["Times New Roman", "Times", "serif"],
            },
          },
        },
      };
    </script>
    <script src="appendable.min.js"></script>
  </head>

  <body class="h-screen w-full flex justify-center">
    <div class="flex flex-col items-center w-10/12 space-y-8">
      <nav
        class="h-12 w-full items-center p-4 font-times text-xl space-x-8 flex"
      >
        <p class="">Appendable</p>
        <p class="">Source Code</p>
      </nav>

      <input
        type="text"
        id="searchbar"
        name="searchbar"
        placeholder="Search"
        required
        class="w-full px-4 py-2 text-xl focus:outline-none shadow-xl rounded-xl border-2 border-gray-300 focus:border-gray-800 transition ease-in duration-300"
        oninput="updateSearchBarState(this.value)"
      />

      <pre id="results"></pre>
    </div>

    <script>
      let dbInstance = null;

      Appendable.init("palo-alto.jsonl", "palo-alto.index", {
        useMultipartByteRanges: false,
      }).then(async (db) => {
        dbInstance = db;
      });
      async function updateSearchBarState(value) {
        document.getElementById("results").innerHTML = "";
        if (value.length >= 3 && dbInstance != null) {
          const query = await dbInstance.query({
            search: {
              key: "description",
              like: value,
              config: {
                minGram: 3,
                maxGram: 3,
              },
            },
          });

          await bindQuery(query);
        }
      }
      async function bindQuery(query) {
        const resultsElement = document.getElementById("results");

        async function appendResult() {
          const result = await query.next();
          if (result.done) {
            return;
          }

          const resultDiv = document.createElement("div");
          resultDiv.classList.add("result-item");

          const { key, score } = result.value;
          resultDiv.textContent = JSON.stringify(key);
          resultsElement.appendChild(resultDiv);
        }

        await appendResult();
      }
    </script>
  </body>
</html>
