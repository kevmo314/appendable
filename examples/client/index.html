<!doctype html>
<html lang="en">
	<head>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"
			type="text/javascript"
			charset="utf-8"
		></script>
		<link rel="stylesheet" href="styles.css" />
		<script src="appendable.min.js"></script>
		<script>
			Appendable.init(
				"green_tripdata_2023-01.csv",
				"green_tripdata_2023-01.csv.index",
			).then(async (db) => {
				let dbFields = [];

				// populate fields
				db.fields().then((fields) => {
					fields.map((field) => {
						dbFields.push(field.fieldName);
					});

					document.getElementById("fields").innerHTML = JSON.stringify(
						fields,
						(key, value) => {
							if (typeof value === "bigint") {
								return value.toString();
							}

							return value;
						},
						2
					);
				});

				// then execute the query
				document.getElementById("execute").onclick = async () => {
					document.getElementById("results-header").innerHTML = "";
					document.getElementById("results").innerHTML = "";

					const editorContent = editor.getValue();

					if (window.activeEditor === "json") {
						const queryJson = JSON.parse(editorContent);
						try {
							const query = await db.query(queryJson);
							let queryHeaders = queryJson.select ?? dbFields;
							await bindQuery(query, queryHeaders);
						} catch (error) {
							console.log("error: ", error);
							document.getElementById("results-header").innerHTML = "";
							document.getElementById("results").innerHTML = error.message;
						}
					} else if (window.activeEditor === "javascript") {
						function extractSelect(content) {
							const selectRegex = /\.select\(\s*\[([^\]]*)\]\s*\)/;
							const match = content.match(selectRegex);

							if (match && match[1]) {
								const headersContent = match[1].trim();
								const headers = headersContent
									.split(",")
									.map((e) => e.trim().replace(/['"`]/g, ""));

								return headers;
							}

							return null;
						}

						try {
							const query = await eval(editorContent);

							const queryHeaders = extractSelect(editorContent) ?? dbFields;

							if (query) {
								await bindQuery(query, queryHeaders);
							}
						} catch (error) {
							console.log("error: ", error);
							document.getElementById("results-header").innerHTML = "";
							document.getElementById("results").innerHTML = error.message;
						}
					}
				};

				const queryJson = JSON.parse(editor.getValue());
				const query = await db.query(JSON.parse(editor.getValue()));

				await bindQuery(query, queryJson.select);
			});

			async function bindQuery(query, headers) {
				const resultsHeaderElement = document.getElementById("results-header");
				resultsHeaderElement.innerHTML = "";

				resultsHeaderElement.style.display = "grid";
				resultsHeaderElement.style.gridTemplateColumns = `repeat(${headers.length}, minmax(	0, 4fr))`;

				headers.forEach((header) => {
					const headerDiv = document.createElement("div");
					headerDiv.textContent = header;
					headerDiv.classList.add("header-item");
					resultsHeaderElement.appendChild(headerDiv);
				});

				const resultsElement = document.getElementById("results");
				document.getElementById("next").disabled = true;

				async function appendResult() {
					const result = await query.next();
					if (result.done) {
						return;
					}

					const resultRow = document.createElement("div");
					resultRow.classList.add("result-row");
					resultRow.style.display = "grid";
					resultRow.style.gridTemplateColumns = `repeat(${headers.length}, minmax(0, 4fr))`;

					headers.forEach((header) => {
						const cellDiv = document.createElement("div");
						cellDiv.classList.add("result-cell");
						cellDiv.textContent = result.value[header]
							? result.value[header]
							: "";
						resultRow.appendChild(cellDiv);
					});

					resultsElement.appendChild(resultRow);
				}

				for (let i = 0; i < 10; i++) {
					await appendResult();
				}
				while (true) {
					document.getElementById("next").disabled = false;
					await new Promise(
						(resolve) => (document.getElementById("next").onclick = resolve)
					);
					document.getElementById("next").disabled = true;
					await appendResult();
				}
			}
		</script>
	</head>
	<body>
		<div>
			<h1>
				<a href="https://github.com/kevmo314/appendable">Appendable</a> - NYC
				Green Cab Trip Data in 01/2023
			</h1>
			<div>
				Download the raw data here:
				<a href="green_tripdata_2023-01.jsonl">JSONL</a> -
				<a href="green_tripdata_2023-01.csv.index">Appendable Index</a> -
				<a href="https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page"
					>Source</a
				>
			</div>
			<p>
				Appendable is querying the JSONL and index files that GitHub pages hosts
				<em>directly</em>. There is no server involved here!
			</p>
			<p>
				Keep in mind that while the query syntax supports a lot of different
				operations, Appendable doesn't support composite indexes yet. Therefore,
				only one field at a time can be filtered on and that field must be used
				for sorting.
			</p>
		</div>
		<div class="flex-1">
			<div>
				<h2>Fields</h2>
				<pre id="fields"></pre>
			</div>
			<div>
				<h2>Query</h2>
				<div>
					<button id="jsonTab">json</button>
					<button id="jsTab">javascript</button>
					<div id="editor" style="height: 400px; width: 628px"></div>
				</div>
				<h2>Results</h2>

				<button id="execute">Execute</button>
				<button id="next">Fetch more</button>
				<div>
					<pre id="results-header"></pre>
					<pre id="results"></pre>
				</div>
			</div>
		</div>
		<script src="editor.js"></script>
	</body>
</html>
