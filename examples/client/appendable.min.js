"use strict";(()=>{var w=class i{constructor(e){this.resolver=e}static forUrl(e){return i.forResolver(async({start:t,end:r})=>{let n=await fetch(e,{headers:{Range:`bytes=${t}-${r}`}}),a=Number(n.headers.get("Content-Range").split("/")[1]);return{data:await n.arrayBuffer(),totalLength:a}})}static forResolver(e){let t=new i(async(r,n,a)=>(await e({start:r,end:n,expectedLength:a})).data);return t.originalResolver=e,t}getResolver(){return this.originalResolver}async get(e,t){let r=await this.resolver(e,t);return new TextDecoder().decode(r)}};var b=(t=>(t[t.JSONL=0]="JSONL",t[t.CSV=1]="CSV",t))(b||{});async function P(i){if(i.byteLength<4)throw new Error(`invalid metadata size ${i.byteLength}`);let e=new DataView(i),t=e.getUint16(0),r=e.getUint16(2);if(i.byteLength<4+r)throw new Error(`invalid metadata size ${i.byteLength}`);let n=i.slice(4,4+r);return{fieldName:new TextDecoder("utf-8").decode(n),fieldType:t}}function A(i){let e=new Map;for(let r of i)if(!e.has(r.fieldName))e.set(r.fieldName,[r.fieldType]);else{let n=e.get(r.fieldName);n?.push(r.fieldType),e.set(r.fieldName,n)}let t=[];return e.forEach((r,n)=>{t.push({fieldName:n,fieldTypes:r})}),t}var K=4096,T=class i{constructor(e,t,r,n,a,o){this.keys=e,this.leafPointers=t,this.internalPointers=r,this.dataFileResolver=n,this.fileFormat=a,this.pageFieldType=o}leaf(){return this.leafPointers.length>0}pointer(e){return this.leaf()?this.leafPointers[e]:{offset:this.internalPointers[e],length:0}}numPointers(){return this.internalPointers.length+this.leafPointers.length}size(){let e=4;for(let t=0;t<=this.keys.length-1;t++){let r=this.keys[t];r.dataPointer.length>0?e+=16:e+=4*r.value.byteLength}for(let t=0;t<=this.leafPointers.length-1;t++)e+=12;for(let t=0;t<=this.internalPointers.length-1;t++)e+=8;return BigInt(e)}async unmarshalBinary(e){let t=new DataView(e),r=t.getUint32(0);if(r>2147483647&&(r=r-4294967296),r<0?(this.leafPointers=new Array(-r).fill({offset:0n,length:0}).map(()=>({offset:0n,length:0})),this.keys=new Array(-r).fill(null).map(()=>new u({offset:0n,length:0},new ArrayBuffer(0)))):(this.internalPointers=Array(r+1).fill(0n).map(()=>0n),this.keys=new Array(r).fill(null).map(()=>new u({offset:0n,length:0},new ArrayBuffer(0)))),r===0)throw new Error("empty node");let a=4;for(let o=0;o<=this.keys.length-1;o++){t=new DataView(e,a,4);let l=t.getUint32(0);if(l===-1>>>0){t=new DataView(e,a+4);let s=t.getBigUint64(0),L=t.getUint32(8);this.keys[o].setDataPointer({offset:s,length:L});let y=this.keys[o].dataPointer,{data:x}=await this.dataFileResolver({start:Number(y.offset),end:Number(y.offset)+y.length-1}),B=await this.parseValue(x);this.keys[o].setValue(B),a+=16}else{let s=e.slice(a+4,a+4+l);this.keys[o].setValue(s),a+=4+l}}for(let o=0;o<=this.leafPointers.length-1;o++)t=new DataView(e,a),this.leafPointers[o].offset=t.getBigUint64(0),this.leafPointers[o].length=t.getUint32(8),a+=12;for(let o=0;o<=this.internalPointers.length-1;o++)t=new DataView(e,a),this.internalPointers[o]=t.getBigUint64(0),a+=8}async parseValue(e){let t=new TextDecoder().decode(e);switch(this.fileFormat){case 0:let r=JSON.parse(t);switch(this.pageFieldType){case 7:if(r!==null)throw new Error(`unrecognized value for null type: ${r}`);return new ArrayBuffer(0);case 6:let n=new ArrayBuffer(1);return new DataView(n).setUint8(0,r?1:0),n;case 3:case 1:case 2:let o=new ArrayBuffer(8);return new DataView(o).setFloat64(0,r,!0),o;case 0:return new TextEncoder().encode(r).buffer;default:throw new Error(`Unexpected Field Type. Got: ${this.pageFieldType}`)}case 1:}throw new Error("unexpected parsing error occured")}static async fromMemoryPointer(e,t,r,n,a){let{data:o}=await t({start:Number(e.offset),end:Number(e.offset)+4096-1}),l=new i([],[],[],r,n,a);return await l.unmarshalBinary(o),{node:l,bytesRead:K}}};var F=class{constructor(e,t){this.tree=e,this.key=t,this.records=[]}async init(){let e=await this.tree.root();if(e.rootNode===null)return!1;let t=e.rootNode,r=e.pointer,n=await this.tree.traverse(this.key,t,r);return this.records=n,!0}getKey(){return this.records[0].node.keys[this.records[0].index]}getPointer(){return this.records[0].node.pointer(this.records[0].index)}async increment(e,t){if(e===this.records.length)return!1;this.records[e].index+=t;let r=this.records[e].index<0,n=this.records[e].index>=this.records[e].node.numPointers();if(r||n){if(!this.increment(e+1,t)||!this.records[e+1])return!1;try{let a=await this.tree.readNode(this.records[e+1].node.pointer(this.records[e+1].index));this.records[e].node=a,r?this.records[e].index=this.records[e].node.numPointers()-1:this.records[e].index=0}catch{return!1}}return!0}async next(){return this.records.length===0?await this.init():this.increment(0,1)}async prev(){return this.records.length===0&&!await this.init()?!1:this.increment(0,-1)}};var N=class{constructor(e,t,r,n,a){this.tree=e,this.meta=t,this.dataFileResolver=r,this.fileFormat=n,this.pageFieldType=a}async root(){let e=await this.meta.root();if(!e||e.length===0)return{rootNode:null,pointer:e};let t=await this.readNode(e);return t?{rootNode:t,pointer:e}:{rootNode:null,pointer:e}}async readNode(e){try{let{node:t,bytesRead:r}=await T.fromMemoryPointer(e,this.tree,this.dataFileResolver,this.fileFormat,this.pageFieldType);if(!r)throw new Error("bytes read do not line up");return t}catch(t){throw new Error(`${t}`)}}iter(e){return new F(this,e)}async traverse(e,t,r){let[n,a]=J(t.keys,e);if(t.leaf())return[{node:t,index:n,pointer:r}];a&&(n+=1);let o=t.pointer(n),l=await this.readNode(o);return[...await this.traverse(e,l,o),{node:t,index:n,pointer:r}]}async find(e){let t=this.iter(e);return await t.next()?[t.getKey(),t.getPointer()]:[new u({offset:0n,length:0},new Uint8Array(0).buffer),{offset:0n,length:0}]}},u=class{constructor(e,t){this.dataPointer=e,this.value=t}setDataPointer(e){this.dataPointer=e}setValue(e){this.value=e}static compareBytes(e,t){let r=new Uint8Array(e),n=new Uint8Array(t),a=Math.min(r.length,n.length);for(let o=0;o<a;o++)if(r[o]!==n[o])return r[o]<n[o]?-1:1;return r.length<n.length?-1:r.length>n.length?1:0}};function E(i,e){let t=u.compareBytes(i.value,e.value);return t!==0?t:i.dataPointer.offset>e.dataPointer.offset?1:i.dataPointer.offset<e.dataPointer.offset?-1:i.dataPointer.length>e.dataPointer.length?1:i.dataPointer.length<e.dataPointer.length?-1:0}function J(i,e){let t=i.length,r=0,n=t;for(;r<n;){let a=Math.floor((r+n)/2);E(i[a],e)<0?r=a+1:n=a}return[r,r<t&&E(i[r],e)===0]}var M=class i{constructor(e){this.database=e;this.queryObject={where:[],orderBy:void 0,select:void 0,limit:void 0}}toQuery(){return{where:this.queryObject.where?[...this.queryObject.where]:[],orderBy:this.queryObject.orderBy?[...this.queryObject.orderBy]:void 0,select:this.queryObject.select?[...this.queryObject.select]:void 0,limit:this.queryObject.limit}}get(){}where(e,t,r){let n=new i(this.database);return n.queryObject={...this.queryObject,where:[...this.queryObject.where||[],{key:e,operation:t,value:r}]},n}orderBy(e,t){let r=new i(this.database);return r.queryObject={...this.queryObject,orderBy:[...this.queryObject.orderBy||[],{key:e,direction:t}]},r}select(e){let t=new i(this.database);return t.queryObject={...this.queryObject,select:e},t}limit(e){let t=new i(this.database);return t.queryObject={...this.queryObject,limit:e},t}};var v=(s=>(s[s.String=0]="String",s[s.Int64=1]="Int64",s[s.Uint64=2]="Uint64",s[s.Float64=3]="Float64",s[s.Object=4]="Object",s[s.Array=5]="Array",s[s.Boolean=6]="Boolean",s[s.Null=7]="Null",s))(v||{});var V=class i{constructor(e,t){this.dataFile=e;this.indexFile=t}static forDataFileAndIndexFile(e,t){return new i(e,t)}async fields(){return await this.indexFile.indexHeaders()}async*query(e){if(new Set((e.where??[]).map(r=>r.key)).size>1)throw new Error("composite indexes not supported... yet");let t=await this.indexFile.indexHeaders();for(let{key:r,value:n,operation:a}of e.where??[]){if(!t.find(c=>c.fieldName===r))throw new Error("field not found");let l,s;if(r===null)s=7,l=new ArrayBuffer(0);else switch(typeof n){case"bigint":case"number":s=3,l=new ArrayBuffer(8),new DataView(l).setFloat64(0,Number(n),!0);break;case"boolean":s=6,l=new ArrayBuffer(1),new DataView(l).setUint8(0,n?1:0);break;case"string":s=0,l=new TextEncoder().encode(n).buffer;break;default:throw new Error("unmatched key type")}let y=(await this.indexFile.seek(r,s))[0],x=this.dataFile.getResolver();if(x===void 0)throw new Error("data file is undefined");let B=new u({offset:0n,length:0},l),{format:j}=await this.indexFile.metadata(),{fieldType:q}=await P(await y.metadata()),p=new N(this.indexFile.getResolver(),y,x,j,q),m=p.iter(B);if(a===">")for(;await m.next();){let c=m.getKey();if(u.compareBytes(l,c.value)===1){let[g,f]=await p.find(c),d=await this.dataFile.get(Number(f.offset),Number(f.offset)+f.length-1);yield JSON.parse(d);break}}else if(a===">=")for(;await m.next();){let c=m.getKey(),h=u.compareBytes(l,c.value);if(h===1||h===0){let[g,f]=await p.find(c),d=await this.dataFile.get(Number(f.offset),Number(f.offset)+f.length-1);yield JSON.parse(d);break}}else if(a==="==")for(;await m.next();){let c=m.getKey();if(u.compareBytes(l,c.value)===0){let[g,f]=await p.find(c),d=await this.dataFile.get(Number(f.offset),Number(f.offset)+f.length-1);yield JSON.parse(d);break}}else if(a==="<="){for(;await m.prev();){let h=m.getKey();if(u.compareBytes(l,h.value)===-1){let[f,d]=await p.find(h),S=await this.dataFile.get(Number(d.offset),Number(d.offset)+d.length-1);yield JSON.parse(S);break}}let c=p.iter(B);for(;await c.next();){let h=c.getKey();if(u.compareBytes(l,h.value)===0){let[f,d]=await p.find(h),S=await this.dataFile.get(Number(d.offset),Number(d.offset)+d.length-1);yield JSON.parse(S);break}}}else for(;await m.prev();){let c=m.getKey();if(u.compareBytes(l,c.value)===-1){let[g,f]=await p.find(c),d=await this.dataFile.get(Number(f.offset),Number(f.offset)+f.length-1);yield JSON.parse(d);break}}}}where(e,t,r){return new M(this).where(e,t,r)}};var Q=4096,$=2n**64n-1n,D=class i{constructor(e,t){this.metaPagePromise=null;this.resolver=e,this.offset=t,this.metaPageData=null}async root(){let t=(await this.getMetaPage()).slice(0,12),r=new DataView(t),n=r.getBigUint64(0),a=r.getUint32(8);return{offset:n,length:a}}async metadata(){let e=await this.getMetaPage(),r=new DataView(e,24).getUint32(0);return e.slice(28,28+r)}async getMetaPage(){return this.metaPageData?this.metaPageData:(this.metaPagePromise||(this.metaPagePromise=this.resolver({start:Number(this.offset),end:Number(this.offset)+Q-1}).then(({data:e})=>(this.metaPageData=e,this.metaPagePromise=null,e)).catch(e=>{throw this.metaPagePromise=null,e})),this.metaPagePromise)}async next(){let e=await this.getMetaPage(),r=new DataView(e,12,8).getBigUint64(0);return r===$?null:new i(this.resolver,r)}getOffset(){return this.offset}};function U(i,e){let t=e.page(0);return new D(i,t)}var k=class extends Error{constructor(){super("length integrity error")}};var z=4096,O=class{constructor(e){this.pageSize=z;this.resolver=e}async readPage(e){if(e<0)throw new Error("page cannot be indexed");let t=(e+1)*this.pageSize,r=t+this.pageSize-1,{data:n}=await this.resolver({start:t,end:r-1});return n}page(e){return e<0?BigInt(0):BigInt(e+1)*BigInt(this.pageSize)}};var R=class i{static async forUrl(e){return await i.forResolver(async({start:t,end:r,expectedLength:n})=>{let a=await fetch(e,{headers:{Range:`bytes=${t}-${r}`}}),o=Number(a.headers.get("Content-Range").split("/")[1]);if(n&&o!==n)throw new k;return{data:await a.arrayBuffer(),totalLength:o}})}static async forResolver(e){return new I(e)}};var I=class{constructor(e){this.resolver=e}getResolver(){return this.resolver}async tree(){if(this._tree)return this._tree;let e=new O(this.resolver),t=U(this.resolver,e);return this._tree=t,t}async metadata(){let t=await(await this.tree()).metadata();if(t.byteLength<10)throw new Error(`incorrect byte length! Want: 10, got ${t.byteLength}`);let r=new DataView(t),n=r.getUint8(0),a=r.getUint8(1);if(Object.values(b).indexOf(a)===-1)throw new Error(`unexpected file format. Got: ${a}`);let o=r.getBigUint64(2);return{version:n,format:a,readOffset:o}}async seek(e,t){let r=await this.tree(),n=[];for(;r;){let a=await r.next();if(a===null)return n;let o=await P(await a.metadata());o.fieldName===e&&(t===3?(o.fieldType===3||o.fieldType===1||o.fieldType===2)&&n.push(a):o.fieldType===t&&n.push(a)),r=a}if(n.length===0)throw new Error(`No LinkedMetaPage with ${e} and type ${t} exists`);return n}async indexHeaders(){let e=[],t=await this.tree();for(;t;){let r=await t.next();if(r===null)return A(e);let n=await r.metadata(),a=await P(n);e.push(a),t=r}return A(e)}};async function H(i,e){return V.forDataFileAndIndexFile(typeof i=="string"?w.forUrl(i):w.forResolver(i),typeof e=="string"?await R.forUrl(e):await R.forResolver(e))}globalThis.Appendable={init:H,FieldType:v};})();
//# sourceMappingURL=appendable.min.js.map
